# 全局配置
config global 'global'
	option enabled '0'
	option wan_interface 'pppoe-wan'
	option algorithm 'hfsc'
	option linklayer 'atm'
	option overhead '32'

# 上传配置
config upload 'upload'
	option total_bandwidth '50000'
	option default_class 'uclass_2'  # normal作为默认类别

# 下载配置
config download 'download'
	option default_class 'dclass_2'  # normal作为默认类别
	option total_bandwidth '100000'

# 算法配置	
config hfsc 'hfsc'
	option latency_mode 'dynamic'
	option sfq_depth 'auto'
	option m1 '0'
	option m2 '0'
	option d '0'

config cake 'cake'
	option diffserv_mode 'diffserv4'  # 四类服务
	option nat 'yes'
	option ack_filter 'yes'
	option memlimit '32Mb'
	option wash 'no'
	option split_gso 'yes'
	option rtt '100ms'
	option overhead '0'
	option mpu '0'
	option quantum '300'  # CAKE quantum

config fq_codel 'fq_codel'
	option target '10ms'
	option limit '1000'
	option quantum '1514'
	option flows '1024'
	option interval '150ms'
	option ecn 'yes'
	option memory_limit '32Mb'
	option drop_batch '64'

config htb 'htb'
	option burst '20k'
	option cburst '20k'
	option rate '1000kbit'
	option ceil '1100kbit'
	option rtt '10'
	option default_class '1:2'
	option ceil_multiplier '1.1'
	option quantum '1514'

config hybrid 'hybrid'
    option sfq_depth '1024'
    option latency_mode 'dynamic'
    option diffserv_mode 'diffserv4'
    option overhead '32'
    option rtt '100ms'
    option memlimit '32Mb'
    option cake_quantum '300'
    option ack_filter 'yes'
    option nat 'yes'
    option wash 'no'
    option ingress 'yes'
    option egress 'yes'
	
# 上传类别定义 - 三大类
config upload_class 'uclass_1'  # realtime (游戏/语音/实时视频) - 最高优先级
	option name 'realtime'
	option percent_bandwidth '15'  # 15%带宽
	option min_bandwidth '10000'   # 最小10Mbps
	option max_bandwidth '20000'   # 最大20Mbps
	option queue_type 'hfsc'  # 混合模式专用字段
	option minRTT 'Yes'  # 最小往返延时

config upload_class 'uclass_2'  # normal (普通流量: 视频/网页/应用) - 主类别
	option name 'normal'
	option percent_bandwidth '70'  # 70%带宽
	option min_bandwidth '35000'   # 保证35Mbps
	option max_bandwidth '80000'   # 最大80Mbps
	option queue_type 'cake'  # 混合模式专用字段
	option minRTT 'No'

config upload_class 'uclass_3'  # bulk (大文件/后台流量) - 低优先级
	option name 'bulk'
	option percent_bandwidth '15'  # 15%带宽
	option min_bandwidth '0'       # 不保证最小带宽
	option max_bandwidth '15000'   # 最大15Mbps
	option queue_type 'fq_codel'  # 混合模式专用字段
	option minRTT 'No'

# 下载类别定义 - 三大类
config download_class 'dclass_1'  # realtime (游戏/语音/实时视频) - 最高优先级
	option name 'realtime'
	option percent_bandwidth '15'  # 15%带宽
	option min_bandwidth '20000'   # 最小20Mbps
	option max_bandwidth '30000'   # 最大30Mbps
	option queue_type 'hfsc'  # 混合模式专用字段
	option minRTT 'Yes'  # 最小往返延时

config download_class 'dclass_2'  # normal (普通流量: 视频/网页/应用) - 主类别
	option name 'normal'
	option percent_bandwidth '70'  # 70%带宽
	option min_bandwidth '70000'   # 保证70Mbps
	option max_bandwidth '150000'  # 最大150Mbps
	option queue_type 'cake'  # 混合模式专用字段
	option minRTT 'No'

config download_class 'dclass_3'  # bulk (大文件/后台流量) - 低优先级
	option name 'bulk'
	option percent_bandwidth '15'  # 15%带宽
	option min_bandwidth '0'       # 不保证最小带宽
	option max_bandwidth '30000'   # 最大30Mbps
	option queue_type 'fq_codel'  # 混合模式专用字段
	option minRTT 'No'

# 下载规则配置
config download_rule 'download_rule_1'  # DNS查询 (realtime类别)
	option class 'dclass_1'
	option test_order '5'
	option family 'inet'
	option srcport '53,5353'
	option connbytes_kb '<=10'
	option proto 'udp'

config download_rule 'download_rule_2'  # 游戏/语音 (realtime类别)
	option class 'dclass_1'
	option test_order '10'
	option family 'inet'
	option proto 'udp'
	option srcport '3074,3478-3480,3659,6000-7000,27015-27030,27960-27970'

config download_rule 'download_rule_3'  # VoIP/SIP (realtime类别)
	option class 'dclass_1'
	option test_order '15'
	option family 'inet'
	option proto 'udp'
	option srcport '5060-5061,10000-20000'

# 视频流媒体规则
config download_rule 'download_video_1'  # 流媒体协议端口
	option class 'dclass_2'
	option test_order '20'
	option family 'inet'
	option proto 'tcp'
	option srcport '80,443,1935,1936,554,8554,8080,8081'

config download_rule 'download_video_2'  # 视频CDN端口范围
	option class 'dclass_2'
	option test_order '25'
	option family 'inet'
	option proto 'tcp'
	option srcport '1024-65535'
	option connbytes_kb '>=100'

config download_rule 'download_video_3'  # HTTP视频流
	option class 'dclass_2'
	option test_order '30'
	option family 'inet'
	option proto 'tcp'
	option srcport '80,443,8080,8081'
	option connbytes_kb '>=512'

config download_rule 'download_video_4'  # QUIC/HTTP3视频
	option class 'dclass_2'
	option test_order '35'
	option family 'inet'
	option proto 'udp'
	option srcport '443,784,8853'
	option connbytes_kb '>=512'

config download_rule 'download_rule_4'  # 小文件HTTPS (normal类别)
	option class 'dclass_2'
	option test_order '40'
	option family 'inet'
	option srcport '443,853'
	option connbytes_kb '<=8'
	option proto 'tcp'

config download_rule 'download_rule_5'  # 网页浏览 (normal类别)
	option class 'dclass_2'
	option test_order '50'
	option family 'inet'
	option srcport '80,443'
	option connbytes_kb '8-768'
	option proto 'tcp'

config download_rule 'download_rule_6'  # 游戏相关端口 (realtime类别)
	option class 'dclass_1'
	option test_order '55'
	option family 'inet'
	option proto 'udp'
	option srcport '10000-12000,12200-13500,16100-18200,19200-20500'

config download_rule 'download_rule_7'  # 大文件下载 (bulk类别)
	option class 'dclass_3'
	option test_order '60'
	option family 'inet'
	option srcport '80,443,8080,20,21'
	option connbytes_kb '>=2048'
	option proto 'tcp'

config download_rule 'download_rule_8'  # UDP动态端口 (normal类别)
	option class 'dclass_2'
	option test_order '70'
	option family 'inet'
	option proto 'udp'
	option srcport '1024-10000,20000-65535'

config download_rule 'download_rule_9'  # TCP动态端口小流量 (normal类别)
	option class 'dclass_2'
	option test_order '80'
	option family 'inet'
	option proto 'tcp'
	option srcport '1024-10000,20000-65535'
	option connbytes_kb '<=256'

config download_rule 'download_rule_10'  # P2P流量 (bulk类别)
	option class 'dclass_3'
	option test_order '100'
	option family 'inet'
	option proto 'tcp'
	option srcport '6881-6999'
	option connbytes_kb '>=1024'

config download_rule 'download_rule_11'  # P2P流量UDP (bulk类别)
	option class 'dclass_3'
	option test_order '110'
	option family 'inet'
	option proto 'udp'
	option srcport '6881-6999'

# 上传规则配置
config upload_rule 'upload_rule_1'  # DNS查询 (realtime类别)
	option class 'uclass_1'
	option test_order '5'
	option family 'inet'
	option dstport '53,5353'
	option connbytes_kb '<=10'
	option proto 'udp'

config upload_rule 'upload_rule_2'  # 游戏/语音 (realtime类别)
	option class 'uclass_1'
	option test_order '10'
	option family 'inet'
	option proto 'udp'
	option dstport '3074,3478-3480,27015-27030,27960-27970,3659,6000-7000'

config upload_rule 'upload_rule_3'  # VoIP/SIP (realtime类别)
	option class 'uclass_1'
	option test_order '15'
	option family 'inet'
	option proto 'udp'
	option dstport '5060-5061,10000-20000'

# 上传视频控制流量
config upload_rule 'upload_video_1'  # 视频控制流量
	option class 'uclass_2'
	option test_order '20'
	option family 'inet'
	option proto 'tcp'
	option dstport '80,443,1935,1936,8080,8081'
	option connbytes_kb '>=50'

config upload_rule 'upload_video_2'  # 视频信令
	option class 'uclass_2'
	option test_order '25'
	option family 'inet'
	option proto 'tcp'
	option dstport '80,443,1935,1936,554,8554'
	option connbytes_kb '<=100'

config upload_rule 'upload_rule_4'  # 小文件HTTPS (normal类别)
	option class 'uclass_2'
	option test_order '40'
	option family 'inet'
	option dstport '80,443,853'
	option connbytes_kb '<=10'
	option proto 'tcp'

config upload_rule 'upload_rule_5'  # 游戏相关端口 (realtime类别)
	option class 'uclass_1'
	option test_order '50'
	option family 'inet'
	option proto 'udp'
	option dstport '10000-12000,12200-13500,16100-18200,19200-20500,27000-28000'

config upload_rule 'upload_rule_6'  # 网页浏览中等流量 (normal类别)
	option class 'uclass_2'
	option test_order '60'
	option family 'inet'
	option proto 'tcp'
	option dstport '80,443,8080'
	option connbytes_kb '10-768'

config upload_rule 'upload_rule_7'  # 大文件上传 (bulk类别)
	option class 'uclass_3'
	option test_order '70'
	option family 'inet'
	option proto 'tcp'
	option dstport '20,21,22'
	option connbytes_kb '>=1024'

config upload_rule 'upload_rule_8'  # UDP动态端口 (normal类别)
	option class 'uclass_2'
	option test_order '80'
	option family 'inet'
	option proto 'udp'
	option dstport '1024-10000,20000-65535'

config upload_rule 'upload_rule_9'  # TCP动态端口小流量 (normal类别)
	option class 'uclass_2'
	option test_order '90'
	option family 'inet'
	option proto 'tcp'
	option dstport '1024-10000,20000-65535'
	option connbytes_kb '<=256'

config upload_rule 'upload_rule_10'  # P2P上传 (bulk类别)
	option class 'uclass_3'
	option test_order '100'
	option family 'inet'
	option proto 'tcp'
	option dstport '6881-6999'

config upload_rule 'upload_rule_11'  # P2P上传UDP (bulk类别)
	option class 'uclass_3'
	option test_order '110'
	option family 'inet'
	option proto 'udp'
	option dstport '6881-6999'
	
# 分层拥塞控制 (Dynamic Bandwidth Adjustment)
config dba 'dba'
	option enabled '0'
    option interval '1'                #检查间隔
    option min_change_kbps '64'       # 带宽改变最小值
    option high_usage_threshold '90'  # 高使用率阈值(%)
	option high_usage_duration '5'   # 高使用率持续时间(秒)
    option low_usage_threshold '50'   # 低使用率阈值(%)
	option low_usage_duration '5'    # 低使用率持续时间(秒)
    option borrow_ratio '0.2'         # 借用空闲带宽的比例
    option min_borrow_kbps '64'       # 最小借用带宽
    option cooldown_time '5'          # 冷却时间(秒)
	option auto_return_enable '0'       # 是否自动归还
	option return_threshold '60'      # 归还阈值(%) - 使用率低于此值时开始归还
    option return_speed '0.1'         # 归还速度比例(每秒归还借出带宽的10%)
